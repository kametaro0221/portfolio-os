<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio OS (Anti-fragile / Simple)</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121a24; --panel2:#0f1620; --text:#e8eef6; --muted:#97a6b8;
      --ok:#35d07f; --warn:#f2c14e; --alert:#ff5b6e; --line:#223042; --chip:#1a2533;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:var(--bg); color:var(--text);}
    header{position:sticky; top:0; z-index:10; background:rgba(11,15,20,.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--line);}
    .wrap{max-width:1100px; margin:0 auto; padding:14px 16px;}
    .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:10px; align-items:baseline;}
    .brand h1{margin:0; font-size:16px; letter-spacing:.4px;}
    .brand .tag{color:var(--muted); font-size:12px;}
    nav{display:flex; gap:8px; flex-wrap:wrap;}
    button.tab{
      background:transparent; color:var(--muted); border:1px solid var(--line);
      padding:8px 10px; border-radius:10px; cursor:pointer; font-size:12px;
    }
    button.tab.active{color:var(--text); border-color:#3a516b; background:rgba(26,37,51,.6)}
    main{padding:18px 16px 28px;}
    .grid{display:grid; gap:12px;}
    @media(min-width:900px){ .grid.cols2{grid-template-columns:1fr 1fr;} .grid.cols3{grid-template-columns:1fr 1fr 1fr;} }
    .card{
      background:linear-gradient(180deg, rgba(18,26,36,.98), rgba(15,22,32,.98));
      border:1px solid var(--line); border-radius:14px; padding:14px;
    }
    .card h2{margin:0 0 10px 0; font-size:13px; color:#cfe0f4; letter-spacing:.3px;}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .bigstate{display:flex; align-items:center; gap:10px; padding:12px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(26,37,51,.5);}
    .bigstate .label{font-size:12px; color:var(--muted)}
    .bigstate .state{font-size:18px; font-weight:700; letter-spacing:.5px;}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(26,37,51,.7); border:1px solid var(--line); font-size:12px;}
    .dot{width:8px; height:8px; border-radius:999px; background:var(--muted);}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.alert{background:var(--alert)}
    .kvs{display:grid; gap:8px;}
    .kv{display:flex; justify-content:space-between; gap:10px; border-bottom:1px dashed rgba(34,48,66,.6); padding:7px 0;}
    .kv:last-child{border-bottom:none}
    .kv .k{color:var(--muted); font-size:12px;}
    .kv .v{font-size:12px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .row > *{flex:0 0 auto}
    input[type="number"], input[type="text"], textarea{
      width:100%; background:rgba(10,14,19,.7); color:var(--text);
      border:1px solid var(--line); border-radius:10px; padding:10px 10px; font-size:12px;
      outline:none;
    }
    textarea{min-height:140px; font-family:var(--mono); line-height:1.4}
    .btn{
      background:rgba(26,37,51,.8); color:var(--text); border:1px solid #3a516b;
      padding:9px 11px; border-radius:10px; cursor:pointer; font-size:12px;
    }
    .btn.secondary{background:transparent; border-color:var(--line); color:var(--muted)}
    .btn.danger{border-color:rgba(255,91,110,.6)}
    .hint{font-size:12px; color:var(--muted); line-height:1.5}
    .split{display:grid; gap:12px;}
    @media(min-width:900px){ .split{grid-template-columns:1.1fr .9fr;} }
    .table{width:100%; border-collapse:collapse; font-size:12px;}
    .table th,.table td{border-bottom:1px solid rgba(34,48,66,.6); padding:8px 6px; text-align:left; vertical-align:top;}
    .table th{color:var(--muted); font-weight:600;}
    .badge{font-size:11px; padding:3px 7px; border-radius:999px; border:1px solid var(--line); background:rgba(26,37,51,.6); color:var(--muted)}
    .right{text-align:right}
    .oktxt{color:var(--ok)} .warntxt{color:var(--warn)} .alerttxt{color:var(--alert)}
    .small{font-size:11px}
    .section{display:none}
    .section.active{display:block}
    .rule{border:1px solid var(--line); background:rgba(26,37,51,.35); border-radius:12px; padding:10px; margin:8px 0;}
    .rule pre{margin:8px 0 0 0; white-space:pre-wrap; word-break:break-word; font-family:var(--mono); font-size:11px; color:#d9e6f6;}
    .rule .title{display:flex; justify-content:space-between; gap:10px; align-items:center;}
    .rule .title b{font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div class="brand">
      <h1>Portfolio OS</h1>
      <div class="tag">anti-fragile Ã— simpleï¼ˆè¡Œå‹•ã—ãªã„åˆ¤æ–­ã‚’æ”¯æ´ï¼‰</div>
    </div>
    <nav>
      <button class="tab active" data-tab="dash">Dashboard</button>
      <button class="tab" data-tab="macro">Macro</button>
      <button class="tab" data-tab="portfolio">Portfolio</button>
      <button class="tab" data-tab="rules">Rules</button>
      <button class="tab" data-tab="log">Log</button>
      <button class="tab" data-tab="settings">Settings</button>
    </nav>
  </div>
</header>

<main class="wrap">

  <!-- DASHBOARD -->
  <section id="dash" class="section active">
    <div class="grid cols2">
      <div class="card">
        <h2>ä»Šæ—¥ã®çŠ¶æ…‹</h2>
        <div class="bigstate" id="bigState">
          <span class="pill"><span class="dot" id="stateDot"></span><span class="label">State</span></span>
          <div>
            <div class="state" id="stateText">â€”</div>
            <div class="muted small" id="stateWhy">â€”</div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="kvs" id="dashKvs"></div>
      </div>

      <div class="card">
        <h2>ä»Šæ—¥ã®çµè«–</h2>
        <div class="rule">
          <div class="title"><b id="todayConclusion">â€”</b><span class="badge" id="asof">â€”</span></div>
          <pre id="todayNote">â€”</pre>
        </div>
        <div class="hint">
          ç›®çš„ï¼šãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’è¦‹ã¦å‹•ãã®ã§ã¯ãªãã€<b>ã€Œä½•ã‚‚ã—ãªãã¦ã„ã„ã€</b>ã‚’ç¢ºèªã™ã‚‹ã€‚<br/>
          ãƒ«ãƒ¼ãƒ«ã«å¼•ã£ã‹ã‹ã£ãŸã¨ãã ã‘ã€Œè¦³æ¸¬ã€ã€Œå‰æå¤‰æ›´æ¤œè¨ã€ã¸ã€‚
        </div>
      </div>
    </div>
  </section>

  <!-- MACRO -->
  <section id="macro" class="section">
    <div class="split">
      <div class="card">
        <h2>ãƒã‚¯ãƒ­å…¥åŠ›ï¼ˆæ‰‹å…¥åŠ›ã§OKï¼‰</h2>
        <div class="grid cols3">
          <div>
            <div class="muted small">USD/JPY</div>
            <input type="number" step="0.01" id="fx" />
          </div>
          <div>
            <div class="muted small">JGB 10Yï¼ˆ%ï¼‰</div>
            <input type="number" step="0.01" id="jgb10y" />
          </div>
          <div>
            <div class="muted small">US 10Yï¼ˆ%ï¼‰</div>
            <input type="number" step="0.01" id="us10y" />
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="grid cols2">
          <label class="pill"><input type="checkbox" id="flagRateOkay" /> åˆ©ä¸Šã’å®¹èªè¨€èªã‚ã‚Š</label>
          <label class="pill"><input type="checkbox" id="flagBoJPressure" /> æ—¥éŠ€ã¸ã®ç›´æ¥åœ§åŠ›ã‚ã‚Š</label>
          <label class="pill"><input type="checkbox" id="flagUniformGiveaway" /> ä¸€å¾‹çµ¦ä»˜ãƒ»æ’ä¹…è£œåŠ©ã®å…†å€™ã‚ã‚Š</label>
          <label class="pill"><input type="checkbox" id="flagFiscalDominance" /> ã€Œé‡‘åˆ©ã¯é«˜ã™ãã‚‹ã€è¨€èªãŒå¢—åŠ </label>
        </div>

        <div style="height:12px"></div>
        <div class="row">
          <button class="btn" id="saveMacro">ä¿å­˜</button>
          <button class="btn secondary" id="resetMacro">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="hint" style="margin-top:10px">
          ã“ã“ã¯ãƒ‹ãƒ¥ãƒ¼ã‚¹æœ¬æ–‡ã‚’è²¼ã‚‰ãªã„ã€‚<br/>
          ã‚ãªãŸãŒã€Œè§£é‡ˆã—ãŸçµæœã®ãƒ•ãƒ©ã‚°ã€ã ã‘ã‚’æ®‹ã™ã“ã¨ã§ã€æƒ…å ±éå¤šã‚’é˜²ãã€‚
        </div>
      </div>

      <div class="card">
        <h2>è¦³æ¸¬çµæœï¼ˆãƒ«ãƒ¼ãƒ«é©ç”¨ï¼‰</h2>
        <div class="kvs" id="macroKvs"></div>
        <div style="height:10px"></div>
        <div class="rule">
          <div class="title"><b>åˆ¤å®šãƒ¡ãƒ¢</b><span class="badge">auto</span></div>
          <pre id="macroAutoMemo">â€”</pre>
        </div>
      </div>
    </div>
  </section>

  <!-- PORTFOLIO -->
  <section id="portfolio" class="section">
    <div class="split">
      <div class="card">
        <h2>ãƒãƒ¼ãƒˆå…¥åŠ›ï¼ˆå††ï¼šç™¾ä¸‡å††å˜ä½ã§ã‚‚OKï¼‰</h2>
        <div class="grid cols2">
          <div>
            <div class="muted small">å††ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆJPYï¼‰</div>
            <input type="number" step="1" id="pJpyCash" />
          </div>
          <div>
            <div class="muted small">ãƒ‰ãƒ«ï¼ˆUSDæ›ç®—JPYã§ã‚‚OKï¼šé‹ç”¨ä¸Šã¯å††æ›ç®—ã§ç®¡ç†ï¼‰</div>
            <input type="number" step="1" id="pUsdBucket" />
          </div>
          <div>
            <div class="muted small">ä¸Šå ´æ ªï¼ˆåˆè¨ˆï¼‰</div>
            <input type="number" step="1" id="pListedTotal" />
          </div>
          <div>
            <div class="muted small">â”” é˜²è¡›æ ªï¼ˆNTT/ä¿¡è¶Š/ç¬¬ä¸€ä¸‰å…±ï¼‰</div>
            <input type="number" step="1" id="pListedDef" />
          </div>
          <div>
            <div class="muted small">â”” æ”»ã‚æ </div>
            <input type="number" step="1" id="pListedAtk" />
          </div>
          <div>
            <div class="muted small">éå…¬é–‹æ ªï¼ˆè‡ªç¤¾ï¼‰</div>
            <input type="number" step="1" id="pPrivate" />
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="row">
          <button class="btn" id="savePort">ä¿å­˜</button>
          <button class="btn secondary" id="resetPort">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="hint" style="margin-top:10px">
          ç›®çš„ã¯ã€Œè©•ä¾¡æç›Šã€ã§ã¯ãªãã€<b>è¨­è¨ˆæ¯”ç‡ãŒå£Šã‚Œã¦ã„ãªã„ã‹</b>ã®ç¢ºèªã€‚<br/>
          ä¾¡æ ¼é€£å‹•ã§æ›´æ–°ã—ãªã„ï¼ˆï¼åˆ¤æ–­åŠ›ã‚’å‰Šã‚‰ãªã„ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <h2>æ§‹æˆãƒã‚§ãƒƒã‚¯</h2>
        <div class="kvs" id="portKvs"></div>
        <div style="height:12px"></div>
        <table class="table" id="portTable"></table>
      </div>
    </div>
  </section>

  <!-- RULES -->
  <section id="rules" class="section">
    <div class="grid cols2">
      <div class="card">
        <h2>ãƒ«ãƒ¼ãƒ«ï¼ˆæ†²æ³•ï¼‰</h2>

        <div class="rule">
          <div class="title">
            <b>åŸºæœ¬ï¼šãƒ¬ãƒ³ã‚¸å†…ãªã‚‰ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</b>
            <span class="badge">core</span>
          </div>
          <pre>
IF FX âˆˆ [FX_LOW, FX_HIGH]
AND JGB10Y &lt; JGB_WATCH
AND (BoJPressure = false)
AND (UniformGiveaway = false)
THEN State = "NO ACTION"
          </pre>
        </div>

        <div class="rule">
          <div class="title">
            <b>è¦³æ¸¬ï¼šé‡‘åˆ©ãŒä¸ŠãŒã‚Šå§‹ã‚ãŸã‚‰è¦‹ã‚‹</b>
            <span class="badge">watch</span>
          </div>
          <pre>
IF JGB10Y âˆˆ [JGB_WATCH, JGB_ALERT)
THEN State = "OBSERVE"
          </pre>
        </div>

        <div class="rule">
          <div class="title">
            <b>å‰æå¤‰æ›´æ¤œè¨ï¼š3%è¶… or æ”¿æ²»ãƒ•ãƒ©ã‚°å¤‰åŒ–</b>
            <span class="badge">alert</span>
          </div>
          <pre>
IF (JGB10Y â‰¥ JGB_ALERT)
OR (BoJPressure = true)
OR (UniformGiveaway = true)
OR (FiscalDominance = true)
THEN State = "ASSUMPTION CHANGE"
          </pre>
        </div>

        <div class="hint">
          ãƒ«ãƒ¼ãƒ«ã¯ã€Œå½“ã¦ã‚‹ã€ãŸã‚ã§ã¯ãªãã€<b>è¡Œå‹•ã‚’æ¸›ã‚‰ã™</b>ãŸã‚ã«ã‚ã‚‹ã€‚<br/>
          é€¸è„±ãŒèµ·ããŸã‚‰ã€æ”»ã‚æ ã§ã¯ãªãã€Œé˜²è¡›å¯„ã‚Šã¸å¾®èª¿æ•´ã€æ¤œè¨ã€‚
        </div>
      </div>

      <div class="card">
        <h2>é–¾å€¤ï¼ˆSettingsã¨é€£å‹•ï¼‰</h2>
        <div class="kvs" id="ruleKvs"></div>
        <div style="height:10px"></div>
        <div class="rule">
          <div class="title"><b>è‡ªå‹•ç”Ÿæˆãƒ¡ãƒ¢</b><span class="badge">auto</span></div>
          <pre id="rulesAutoMemo">â€”</pre>
        </div>
      </div>
    </div>
  </section>

  <!-- LOG -->
  <section id="log" class="section">
    <div class="split">
      <div class="card">
        <h2>åˆ¤æ–­ãƒ­ã‚°ï¼ˆæœªæ¥ã®è‡ªåˆ†ã«èª¬æ˜ã™ã‚‹ï¼‰</h2>
        <div class="grid cols2">
          <div>
            <div class="muted small">æ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰</div>
            <input type="text" id="logDate" placeholder="2026-02-08" />
          </div>
          <div>
            <div class="muted small">åˆ¤æ–­</div>
            <input type="text" id="logDecision" placeholder="ä½•ã‚‚ã—ãªã„ / è¦³æ¸¬ç¶™ç¶š / å‰æå¤‰æ›´æ¤œè¨" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="muted small">ãƒ¡ãƒ¢ï¼ˆçŠ¶æ³è¦ç´„ï¼šçŸ­ãï¼‰</div>
        <textarea id="logMemo" placeholder="ä¾‹ï¼šç‚ºæ›¿ãƒ¬ãƒ³ã‚¸å†…ã€‚JGB10Yã¯2.1%ã€‚æ”¿æ²»ãƒ•ãƒ©ã‚°å¤‰åŒ–ãªã—ã€‚â†’ä½•ã‚‚ã—ãªã„"></textarea>
        <div style="height:12px"></div>
        <div class="row">
          <button class="btn" id="addLog">è¿½åŠ </button>
          <button class="btn secondary" id="clearLog">å…¨æ¶ˆå»</button>
        </div>
        <div class="hint" style="margin-top:10px">
          ã“ã‚Œã¯ã€Œå£²è²·è¨˜éŒ²ã€ã§ã¯ãªãã€<b>â€œä½•ã‚‚ã—ãªã‹ã£ãŸç†ç”±â€</b>ã®ä¿å­˜ã€‚<br/>
          ç›¸å ´ãŒè’ã‚ŒãŸã¨ãã»ã©åŠ¹ãã€‚
        </div>
      </div>

      <div class="card">
        <h2>ãƒ­ã‚°ä¸€è¦§</h2>
        <table class="table" id="logTable"></table>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="section">
    <div class="split">
      <div class="card">
        <h2>é–¾å€¤è¨­å®šï¼ˆã‚ãªãŸä»•æ§˜ï¼‰</h2>
        <div class="grid cols3">
          <div>
            <div class="muted small">FX_LOW</div>
            <input type="number" step="0.1" id="sFxLow" />
          </div>
          <div>
            <div class="muted small">FX_HIGH</div>
            <input type="number" step="0.1" id="sFxHigh" />
          </div>
          <div>
            <div class="muted small">JGB_WATCHï¼ˆ%ï¼‰</div>
            <input type="number" step="0.01" id="sJgbWatch" />
          </div>
          <div>
            <div class="muted small">JGB_ALERTï¼ˆ%ï¼‰</div>
            <input type="number" step="0.01" id="sJgbAlert" />
          </div>
          <div>
            <div class="muted small">PORT_TOLERANCEï¼ˆ%ï¼‰</div>
            <input type="number" step="1" id="sPortTol" />
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="row">
          <button class="btn" id="saveSettings">ä¿å­˜</button>
          <button class="btn secondary" id="resetAll">åˆæœŸåŒ–ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼‰</button>
        </div>
        <div class="hint" style="margin-top:10px">
          PORT_TOLERANCEï¼šãƒãƒ¼ãƒˆæ¯”ç‡ã®è¨±å®¹ã‚ºãƒ¬ï¼ˆç›®å®‰ï¼‰ã€‚<br/>
          ä¾‹ï¼šÂ±5% ãªã‚‰ã€è¨­è¨ˆã‚’å£Šã•ãªã„ç¯„å›²ã§ã®èª¤å·®ã¨ã—ã¦è¨±å®¹ã€‚
        </div>
      </div>

      <div class="card">
        <h2>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰</h2>
        <div class="hint">ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorage ã«ä¿å­˜ã€‚åˆ¥PCã«ç§»ã™ãªã‚‰ã“ã“ã§JSONã‚’å‡ºã—å…¥ã‚Œã€‚</div>
        <div style="height:8px"></div>
        <textarea id="jsonBox" spellcheck="false"></textarea>
        <div style="height:10px"></div>
        <div class="row">
          <button class="btn" id="exportJson">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button class="btn" id="importJson">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button class="btn secondary" id="copyJson">ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>
    </div>
  </section>

</main>

<script>
/** ===========
 * Data Model
 * ============ */
const STORAGE_KEY = "portfolio_os_v1";

const defaultState = {
  settings: {
    FX_LOW: 140,
    FX_HIGH: 155,
    JGB_WATCH: 2.5,
    JGB_ALERT: 3.0,
    PORT_TOLERANCE_PCT: 5
  },
  macro: {
    fx: 150.0,
    jgb10y: 2.10,
    us10y: 4.10,
    flags: {
      rateOkayLanguage: true,
      bojPressure: false,
      uniformGiveaway: false,
      fiscalDominance: false
    },
    updatedAt: null
  },
  portfolio: {
    jpyCash: 170000000,
    usdBucket: 100000000,
    listedTotal: 150000000,
    listedDef: 100000000,
    listedAtk: 50000000,
    privateEquity: 200000000,
    updatedAt: null
  },
  logs: [
    // {date:"2026-02-08", decision:"ä½•ã‚‚ã—ãªã„", memo:"ç‚ºæ›¿ãƒ¬ãƒ³ã‚¸å†…ã€‚é‡‘åˆ©2.1%ã€‚æ”¿æ²»ãƒ•ãƒ©ã‚°å¤‰åŒ–ãªã—ã€‚", createdAt: 0}
  ]
};

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return structuredClone(defaultState);
    const parsed = JSON.parse(raw);
    // Shallow merge fallback
    return {
      ...structuredClone(defaultState),
      ...parsed,
      settings: {...structuredClone(defaultState.settings), ...(parsed.settings||{})},
      macro: {...structuredClone(defaultState.macro), ...(parsed.macro||{}),
        flags: {...structuredClone(defaultState.macro.flags), ...((parsed.macro||{}).flags||{})}
      },
      portfolio: {...structuredClone(defaultState.portfolio), ...(parsed.portfolio||{})},
      logs: Array.isArray(parsed.logs) ? parsed.logs : []
    };
  }catch(e){
    console.error(e);
    return structuredClone(defaultState);
  }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(app));
}

let app = loadState();

/** ===========
 * Helpers
 * ============ */
const fmtJPY = (n) => {
  if(n === null || n === undefined || isNaN(n)) return "â€”";
  return new Intl.NumberFormat("ja-JP").format(Math.round(n)) + "å††";
};
const fmtPct = (n, digits=2) => {
  if(n === null || n === undefined || isNaN(n)) return "â€”";
  return Number(n).toFixed(digits) + "%";
};
const fmtNum = (n, digits=2) => {
  if(n === null || n === undefined || isNaN(n)) return "â€”";
  return Number(n).toFixed(digits);
};
const todayISO = () => new Date().toISOString().slice(0,10);
const nowTs = () => Date.now();

function setText(id, text){ document.getElementById(id).textContent = text; }
function setHTML(id, html){ document.getElementById(id).innerHTML = html; }

/** ===========
 * Rules Engine
 * ============ */
function evaluate(){
  const s = app.settings;
  const m = app.macro;

  const inFxRange = (m.fx >= s.FX_LOW && m.fx <= s.FX_HIGH);
  const isWatchRate = (m.jgb10y >= s.JGB_WATCH && m.jgb10y < s.JGB_ALERT);
  const isAlertRate = (m.jgb10y >= s.JGB_ALERT);

  const f = m.flags;
  const anyPoliticalAlert = (f.bojPressure || f.uniformGiveaway || f.fiscalDominance);

  // State logic (simple & conservative)
  let state = "NO ACTION";
  let why = [];

  if(isAlertRate || anyPoliticalAlert){
    state = "ASSUMPTION CHANGE";
    if(isAlertRate) why.push(`JGB10Y â‰¥ ${s.JGB_ALERT}%`);
    if(f.bojPressure) why.push("æ—¥éŠ€ã¸ã®ç›´æ¥åœ§åŠ›");
    if(f.uniformGiveaway) why.push("ä¸€å¾‹çµ¦ä»˜/æ’ä¹…è£œåŠ©ã®å…†å€™");
    if(f.fiscalDominance) why.push("ã€é‡‘åˆ©ã¯é«˜ã™ãã‚‹ã€è¨€èªå¢—");
  } else if(isWatchRate || !inFxRange){
    state = "OBSERVE";
    if(isWatchRate) why.push(`JGB10Y âˆˆ [${s.JGB_WATCH}%, ${s.JGB_ALERT}%)`);
    if(!inFxRange) why.push(`FXãŒãƒ¬ãƒ³ã‚¸å¤–ï¼ˆ${s.FX_LOW}â€“${s.FX_HIGH}ï¼‰`);
  } else {
    // Core no-action conditions
    // Still allow note if rateOkayLanguage disappears (optional mild)
    if(!f.rateOkayLanguage) {
      // not immediate alert; just observe nuance
      state = "OBSERVE";
      why.push("åˆ©ä¸Šã’å®¹èªè¨€èªãŒå¼±ã„/æ¶ˆå¤±");
    } else {
      state = "NO ACTION";
      why.push("ãƒ¬ãƒ³ã‚¸å†…ãƒ»é‡‘åˆ©è­¦æˆ’åŸŸæœªæº€ãƒ»æ”¿æ²»ãƒ•ãƒ©ã‚°å®‰å®š");
    }
  }

  // Action guidance
  let conclusion = "";
  let note = "";

  if(state === "NO ACTION"){
    conclusion = "âœ… è¡Œå‹•ä¸è¦ï¼ˆãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰";
    note =
`ãƒ»ç‚ºæ›¿ï¼šãƒ¬ãƒ³ã‚¸å†…ãªã‚‰è§¦ã‚‰ãªã„
ãƒ»ç›®çš„ï¼šåˆ¤æ–­åŠ›ã‚’å‰Šã‚‰ãªã„
ãƒ»ã‚„ã‚‹ãªã‚‰ï¼šãƒ­ã‚°ã ã‘æ®‹ã™ï¼ˆä½•ã‚‚ã—ãªã„ç†ç”±ï¼‰`;
  } else if(state === "OBSERVE"){
    conclusion = "âš  è¦³æ¸¬ãƒ¢ãƒ¼ãƒ‰ï¼ˆå‹•ã‹ãªã„ï¼è¦‹ã‚‹ï¼‰";
    note =
`ãƒ»çµè«–ï¼šåŸºæœ¬ã¯å‹•ã‹ãªã„
ãƒ»è¦‹ã‚‹ã‚‚ã®ï¼šJGB10Y / FXãƒ¬ãƒ³ã‚¸é€¸è„± / æ”¿æ²»ãƒ•ãƒ©ã‚°ã®å¤‰åŒ–
ãƒ»æ”»ã‚æ ã‚’å¢—ã‚„ã•ãªã„ï¼ˆæˆåŠŸä½“é¨“ã§å£Šã‚Œã‚‹ã®ã‚’é˜²ãï¼‰`;
  } else {
    conclusion = "ğŸš¨ å‰æå¤‰æ›´æ¤œè¨ï¼ˆé˜²è¡›å¯„ã‚Šã¸ï¼‰";
    note =
`ãƒ»ã¾ãšå£²è²·ã‚ˆã‚Šå‰ã«å‰æãƒã‚§ãƒƒã‚¯ï¼ˆæ”¿æ²»ãƒ»åˆ¶åº¦ãƒ»è¨€èªï¼‰
ãƒ»æ–¹å‘æ€§ï¼šãƒ‰ãƒ«ç¶­æŒã€œå¾®å¢—ã€å††ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŸ­æœŸåŒ–ã€æ”»ã‚æ ç¸®å°ã‚’æ¤œè¨
ãƒ»ãƒ«ãƒ¼ãƒ«ã«å¾“ã„ã€æ®µéšçš„ï¼ˆåˆ†å‰²ï¼‰ã«å§¿å‹¢å¤‰æ›´`;
  }

  return { state, why, conclusion, note, inFxRange, isWatchRate, isAlertRate };
}

/** ===========
 * UI Renderers
 * ============ */
function renderDashboard(){
  const ev = evaluate();
  const m = app.macro;
  const s = app.settings;

  const stateTextMap = {
    "NO ACTION":"NO ACTION",
    "OBSERVE":"OBSERVE",
    "ASSUMPTION CHANGE":"ASSUMPTION CHANGE"
  };
  const dot = document.getElementById("stateDot");
  dot.className = "dot " + (ev.state==="NO ACTION" ? "ok" : ev.state==="OBSERVE" ? "warn" : "alert");

  setText("stateText", stateTextMap[ev.state]);
  setText("stateWhy", ev.why.join(" / "));

  const dashRows = [
    ["æ—¥ä»˜", todayISO()],
    ["USD/JPY", `${fmtNum(m.fx,2)}ï¼ˆãƒ¬ãƒ³ã‚¸ ${s.FX_LOW}â€“${s.FX_HIGH}ï¼‰`],
    ["JGB10Y", `${fmtPct(m.jgb10y,2)}ï¼ˆwatch ${s.JGB_WATCH} / alert ${s.JGB_ALERT}ï¼‰`],
    ["US10Y", `${fmtPct(m.us10y,2)}`],
    ["æ”¿æ²»ãƒ•ãƒ©ã‚°", [
      m.flags.rateOkayLanguage ? "åˆ©ä¸Šã’å®¹èªã‚ã‚Š" : "åˆ©ä¸Šã’å®¹èªå¼±ã„/ãªã—",
      m.flags.bojPressure ? "æ—¥éŠ€åœ§åŠ›" : null,
      m.flags.uniformGiveaway ? "ä¸€å¾‹çµ¦ä»˜å…†å€™" : null,
      m.flags.fiscalDominance ? "é‡‘åˆ©é«˜ã™ãè¨€èª" : null
    ].filter(Boolean).join(" / ") || "â€”"],
    ["æœ€çµ‚æ›´æ–°", m.updatedAt ? new Date(m.updatedAt).toLocaleString("ja-JP") : "â€”"]
  ];

  setHTML("dashKvs", dashRows.map(([k,v]) =>
    `<div class="kv"><div class="k">${k}</div><div class="v mono">${v}</div></div>`
  ).join(""));

  setText("todayConclusion", ev.conclusion);
  setText("todayNote", ev.note);
  setText("asof", "as of " + todayISO());
}

function renderMacro(){
  const m = app.macro;
  document.getElementById("fx").value = m.fx ?? "";
  document.getElementById("jgb10y").value = m.jgb10y ?? "";
  document.getElementById("us10y").value = m.us10y ?? "";

  document.getElementById("flagRateOkay").checked = !!m.flags.rateOkayLanguage;
  document.getElementById("flagBoJPressure").checked = !!m.flags.bojPressure;
  document.getElementById("flagUniformGiveaway").checked = !!m.flags.uniformGiveaway;
  document.getElementById("flagFiscalDominance").checked = !!m.flags.fiscalDominance;

  const ev = evaluate();

  const rows = [
    ["é‡‘åˆ©å·®ï¼ˆUS10Y - JGB10Yï¼‰", fmtPct((m.us10y - m.jgb10y),2)],
    ["ç‚ºæ›¿ãƒ¬ãƒ³ã‚¸å†…ï¼Ÿ", ev.inFxRange ? `<span class="oktxt">YES</span>` : `<span class="alerttxt">NO</span>`],
    ["JGBç›£è¦–åŸŸï¼Ÿ", ev.isWatchRate ? `<span class="warntxt">YES</span>` : "NO"],
    ["JGBè­¦å ±åŸŸï¼Ÿ", ev.isAlertRate ? `<span class="alerttxt">YES</span>` : "NO"],
    ["çŠ¶æ…‹", `<b class="${ev.state==='NO ACTION'?'oktxt':ev.state==='OBSERVE'?'warntxt':'alerttxt'}">${ev.state}</b>`],
    ["æ ¹æ‹ ", ev.why.join(" / ")]
  ];
  setHTML("macroKvs", rows.map(([k,v]) => `<div class="kv"><div class="k">${k}</div><div class="v mono">${v}</div></div>`).join(""));

  setText("macroAutoMemo",
`è¦³æ¸¬ã®è¦ç‚¹ï¼š
- FXã¯ã€Œãƒ¬ãƒ³ã‚¸å†…ã‹ã€ã ã‘ã‚’è¦‹ã‚‹ï¼ˆå½“ã¦ã«è¡Œã‹ãªã„ï¼‰
- JGB10YãŒ2.5%è¶…â†’è¦³æ¸¬ã€3.0%è¶…â†’å‰æå¤‰æ›´æ¤œè¨
- æ”¿æ²»ãƒ•ãƒ©ã‚°ï¼ˆåœ§åŠ›ãƒ»ä¸€å¾‹çµ¦ä»˜ãƒ»é‡‘åˆ©å¦å®šè¨€èªï¼‰ãŒå‡ºãŸã‚‰å³ã€Œå‰æå¤‰æ›´ã€`);
}

function renderPortfolio(){
  const p = app.portfolio;
  document.getElementById("pJpyCash").value = p.jpyCash ?? "";
  document.getElementById("pUsdBucket").value = p.usdBucket ?? "";
  document.getElementById("pListedTotal").value = p.listedTotal ?? "";
  document.getElementById("pListedDef").value = p.listedDef ?? "";
  document.getElementById("pListedAtk").value = p.listedAtk ?? "";
  document.getElementById("pPrivate").value = p.privateEquity ?? "";

  const total = (p.jpyCash||0)+(p.usdBucket||0)+(p.listedTotal||0)+(p.privateEquity||0);
  const pct = (x)=> total>0 ? (x/total*100) : 0;

  const tol = app.settings.PORT_TOLERANCE_PCT;

  // Reference target (your current design)
  const target = {
    jpyCash: 28,
    usdBucket: 17,
    listedTotal: 25,
    privateEquity: 33
  };

  const rows = [
    ["ç·é¡", fmtJPY(total)],
    ["å††ã‚­ãƒ£ãƒƒã‚·ãƒ¥", `${fmtJPY(p.jpyCash)} / ${fmtNum(pct(p.jpyCash),1)}%ï¼ˆç›®æ¨™ ${target.jpyCash}%ï¼‰`],
    ["ãƒ‰ãƒ«ãƒã‚±ãƒƒãƒˆ", `${fmtJPY(p.usdBucket)} / ${fmtNum(pct(p.usdBucket),1)}%ï¼ˆç›®æ¨™ ${target.usdBucket}%ï¼‰`],
    ["ä¸Šå ´æ ªï¼ˆåˆè¨ˆï¼‰", `${fmtJPY(p.listedTotal)} / ${fmtNum(pct(p.listedTotal),1)}%ï¼ˆç›®æ¨™ ${target.listedTotal}%ï¼‰`],
    ["â”” é˜²è¡›æ ª", `${fmtJPY(p.listedDef)} / ${fmtNum(pct(p.listedDef),1)}%`],
    ["â”” æ”»ã‚æ ", `${fmtJPY(p.listedAtk)} / ${fmtNum(pct(p.listedAtk),1)}%`],
    ["éå…¬é–‹æ ª", `${fmtJPY(p.privateEquity)} / ${fmtNum(pct(p.privateEquity),1)}%ï¼ˆç›®æ¨™ ${target.privateEquity}%ï¼‰`],
    ["æœ€çµ‚æ›´æ–°", p.updatedAt ? new Date(p.updatedAt).toLocaleString("ja-JP") : "â€”"]
  ];
  setHTML("portKvs", rows.map(([k,v])=>`<div class="kv"><div class="k">${k}</div><div class="v mono">${v}</div></div>`).join(""));

  // Table view
  const tableRows = [
    ["å††ã‚­ãƒ£ãƒƒã‚·ãƒ¥", pct(p.jpyCash), target.jpyCash],
    ["ãƒ‰ãƒ«ãƒã‚±ãƒƒãƒˆ", pct(p.usdBucket), target.usdBucket],
    ["ä¸Šå ´æ ªï¼ˆåˆè¨ˆï¼‰", pct(p.listedTotal), target.listedTotal],
    ["éå…¬é–‹æ ª", pct(p.privateEquity), target.privateEquity],
  ].map(([name, actual, t])=>{
    const diff = actual - t;
    const abs = Math.abs(diff);
    const cls = abs<=tol ? "oktxt" : abs<=tol*2 ? "warntxt" : "alerttxt";
    return `<tr>
      <td>${name}</td>
      <td class="mono">${fmtNum(actual,1)}%</td>
      <td class="mono">${fmtNum(t,1)}%</td>
      <td class="mono ${cls}">${diff>=0?"+":""}${fmtNum(diff,1)}%</td>
      <td class="mono">${abs<=tol ? "OK" : "CHECK"}</td>
    </tr>`;
  }).join("");

  setHTML("portTable",
`<thead><tr>
  <th>Bucket</th><th>Actual</th><th>Target</th><th>Diff</th><th>Status</th>
</tr></thead>
<tbody>${tableRows}</tbody>`
  );
}

function renderRules(){
  const s = app.settings;
  const rows = [
    ["FX_LOW", s.FX_LOW],
    ["FX_HIGH", s.FX_HIGH],
    ["JGB_WATCH", s.JGB_WATCH + "%"],
    ["JGB_ALERT", s.JGB_ALERT + "%"],
    ["PORT_TOLERANCE", s.PORT_TOLERANCE_PCT + "%"]
  ];
  setHTML("ruleKvs", rows.map(([k,v])=>`<div class="kv"><div class="k">${k}</div><div class="v mono">${v}</div></div>`).join(""));
  setText("rulesAutoMemo",
`ã“ã®OSã®è¨­è¨ˆæ€æƒ³ï¼š
- äºˆæ¸¬ã—ãªã„
- ãƒ«ãƒ¼ãƒ«ã§ã€Œå‹•ã‹ãªã„ã€ã‚’æ­£å½“åŒ–ã™ã‚‹
- é€¸è„±ã¯æ”¿æ²»/åˆ¶åº¦/è¨€èªã«å…ˆã«å‡ºã‚‹
- ã ã‹ã‚‰ä¾¡æ ¼ã§ã¯ãªããƒ•ãƒ©ã‚°ã‚’ç›£è¦–ã™ã‚‹`);
}

function renderLogs(){
  document.getElementById("logDate").value = todayISO();
  document.getElementById("logDecision").value = "ä½•ã‚‚ã—ãªã„";

  const logs = (app.logs||[]).slice().sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  const body = logs.map(l=>`<tr>
    <td class="mono">${l.date||""}</td>
    <td>${l.decision||""}</td>
    <td>${(l.memo||"").replaceAll("<","&lt;")}</td>
  </tr>`).join("");
  setHTML("logTable", `<thead><tr><th>Date</th><th>Decision</th><th>Memo</th></tr></thead><tbody>${body||""}</tbody>`);
}

function renderSettings(){
  const s = app.settings;
  document.getElementById("sFxLow").value = s.FX_LOW;
  document.getElementById("sFxHigh").value = s.FX_HIGH;
  document.getElementById("sJgbWatch").value = s.JGB_WATCH;
  document.getElementById("sJgbAlert").value = s.JGB_ALERT;
  document.getElementById("sPortTol").value = s.PORT_TOLERANCE_PCT;

  document.getElementById("jsonBox").value = "";
}

function renderAll(){
  renderDashboard();
  renderMacro();
  renderPortfolio();
  renderRules();
  renderLogs();
  renderSettings();
}

/** ===========
 * Events
 * ============ */
document.querySelectorAll("button.tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll("button.tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(tab).classList.add("active");
    // lazy refresh
    renderAll();
    window.scrollTo({top:0, behavior:"smooth"});
  });
});

// Macro save/reset
document.getElementById("saveMacro").addEventListener("click", ()=>{
  const fx = Number(document.getElementById("fx").value);
  const jgb = Number(document.getElementById("jgb10y").value);
  const us = Number(document.getElementById("us10y").value);

  if([fx,jgb,us].some(x=>Number.isNaN(x))){
    alert("æ•°å€¤ãŒä¸æ­£ã§ã™ï¼ˆFX/JGB/USï¼‰ã€‚");
    return;
  }
  app.macro.fx = fx;
  app.macro.jgb10y = jgb;
  app.macro.us10y = us;
  app.macro.flags.rateOkayLanguage = document.getElementById("flagRateOkay").checked;
  app.macro.flags.bojPressure = document.getElementById("flagBoJPressure").checked;
  app.macro.flags.uniformGiveaway = document.getElementById("flagUniformGiveaway").checked;
  app.macro.flags.fiscalDominance = document.getElementById("flagFiscalDominance").checked;
  app.macro.updatedAt = nowTs();
  saveState();
  renderAll();
  alert("Macroã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
});
document.getElementById("resetMacro").addEventListener("click", ()=>{
  app.macro = structuredClone(defaultState.macro);
  saveState();
  renderAll();
});

// Portfolio save/reset
document.getElementById("savePort").addEventListener("click", ()=>{
  const p = app.portfolio;
  const read = (id)=> Number(document.getElementById(id).value);
  const vals = {
    jpyCash: read("pJpyCash"),
    usdBucket: read("pUsdBucket"),
    listedTotal: read("pListedTotal"),
    listedDef: read("pListedDef"),
    listedAtk: read("pListedAtk"),
    privateEquity: read("pPrivate")
  };
  if(Object.values(vals).some(x=>Number.isNaN(x) || x<0)){
    alert("ãƒãƒ¼ãƒˆã®æ•°å€¤ãŒä¸æ­£ã§ã™ã€‚");
    return;
  }
  if(vals.listedDef + vals.listedAtk !== vals.listedTotal){
    alert("ä¸Šå ´æ ªï¼šé˜²è¡›ï¼‹æ”»ã‚ãŒåˆè¨ˆã¨ä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }
  Object.assign(p, vals);
  p.updatedAt = nowTs();
  saveState();
  renderAll();
  alert("Portfolioã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
});
document.getElementById("resetPort").addEventListener("click", ()=>{
  app.portfolio = structuredClone(defaultState.portfolio);
  saveState();
  renderAll();
});

// Logs
document.getElementById("addLog").addEventListener("click", ()=>{
  const date = document.getElementById("logDate").value.trim() || todayISO();
  const decision = document.getElementById("logDecision").value.trim() || "ä½•ã‚‚ã—ãªã„";
  const memo = document.getElementById("logMemo").value.trim();
  if(!memo){
    alert("ãƒ¡ãƒ¢ã¯çŸ­ãã¦ã‚‚è‰¯ã„ã®ã§å…¥ã‚Œã¦ãã ã•ã„ã€‚");
    return;
  }
  app.logs.push({date, decision, memo, createdAt: nowTs()});
  saveState();
  document.getElementById("logMemo").value = "";
  renderAll();
});
document.getElementById("clearLog").addEventListener("click", ()=>{
  if(!confirm("ãƒ­ã‚°ã‚’å…¨æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  app.logs = [];
  saveState();
  renderAll();
});

// Settings
document.getElementById("saveSettings").addEventListener("click", ()=>{
  const s = app.settings;
  const read = (id)=> Number(document.getElementById(id).value);
  const FX_LOW = read("sFxLow");
  const FX_HIGH = read("sFxHigh");
  const JGB_WATCH = read("sJgbWatch");
  const JGB_ALERT = read("sJgbAlert");
  const PORT_TOLERANCE_PCT = read("sPortTol");

  if([FX_LOW,FX_HIGH,JGB_WATCH,JGB_ALERT,PORT_TOLERANCE_PCT].some(x=>Number.isNaN(x))){
    alert("Settingsã®æ•°å€¤ãŒä¸æ­£ã§ã™ã€‚");
    return;
  }
  if(FX_LOW >= FX_HIGH){
    alert("FX_LOWã¯FX_HIGHæœªæº€ã«ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  if(JGB_WATCH >= JGB_ALERT){
    alert("JGB_WATCHã¯JGB_ALERTæœªæº€ã«ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  Object.assign(s, {FX_LOW, FX_HIGH, JGB_WATCH, JGB_ALERT, PORT_TOLERANCE_PCT});
  saveState();
  renderAll();
  alert("Settingsã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
});

document.getElementById("resetAll").addEventListener("click", ()=>{
  if(!confirm("ã™ã¹ã¦åˆæœŸåŒ–ã—ã¾ã™ï¼ˆMacro/Portfolio/Logs/Settingsï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  localStorage.removeItem(STORAGE_KEY);
  app = loadState();
  renderAll();
});

// Export/Import
document.getElementById("exportJson").addEventListener("click", ()=>{
  document.getElementById("jsonBox").value = JSON.stringify(app, null, 2);
});
document.getElementById("copyJson").addEventListener("click", async ()=>{
  const txt = document.getElementById("jsonBox").value.trim();
  if(!txt){ alert("å…ˆã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚"); return; }
  try{
    await navigator.clipboard.writeText(txt);
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
  }catch(e){
    alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
  }
});
document.getElementById("importJson").addEventListener("click", ()=>{
  const txt = document.getElementById("jsonBox").value.trim();
  if(!txt){ alert("JSONãŒç©ºã§ã™ã€‚"); return; }
  try{
    const parsed = JSON.parse(txt);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
    app = loadState();
    renderAll();
    alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚");
  }catch(e){
    alert("JSONã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚");
  }
});

// Init
renderAll();
</script>
</body>
</html>
