<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio OS</title>
  <style>
    body{
      margin:0;
      background:#0b0f14;
      color:#e8eef6;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    header{
      padding:14px 20px;
      border-bottom:1px solid #223042;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    header h1{
      font-size:16px;
      margin:0;
      letter-spacing:.5px;
    }
    nav button{
      margin-left:6px;
      background:#121a24;
      color:#9fb2c8;
      border:1px solid #223042;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
    }
    nav button.active{
      color:#e8eef6;
      border-color:#4c6ef5;
    }
    main{
      padding:20px;
      max-width:1200px;
      margin:auto;
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
    }
    .card{
      background:#121a24;
      border:1px solid #223042;
      border-radius:12px;
      padding:16px;
    }
    .card h2{
      margin:0 0 12px 0;
      font-size:14px;
      color:#cfe0f4;
    }
    input{
      width:100%;
      padding:10px;
      margin-bottom:10px;
      background:#0b0f14;
      color:#e8eef6;
      border:1px solid #223042;
      border-radius:8px;
    }
    label{
      display:block;
      margin-bottom:6px;
      font-size:12px;
      color:#9fb2c8;
    }
    .flags label{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    button{
      background:#1a2533;
      border:1px solid #4c6ef5;
      color:#e8eef6;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      margin-right:6px;
    }
    .status{
      font-size:18px;
      font-weight:bold;
    }
    .ok{color:#35d07f}
    .warn{color:#f2c14e}
    .alert{color:#ff5b6e}
    pre{
      background:#0b0f14;
      padding:12px;
      border-radius:8px;
      border:1px solid #223042;
      white-space:pre-wrap;
      font-size:12px;
    }
  </style>
</head>

<body>

<header>
  <h1>Portfolio OS <span style="font-size:12px;color:#9fb2c8">anti-fragile × simple</span></h1>
  <nav>
    <button class="active">Macro</button>
  </nav>
</header>

<main>

<div class="grid">

  <!-- 左：入力 -->
  <div class="card">
    <h2>マクロ入力（数値は自動取得）</h2>

    <label>USD / JPY</label>
    <input id="fx" />

    <label>日本10年国債利回り（%）</label>
    <input id="jgb" />

    <label>米10年国債利回り（%）</label>
    <input id="us" />

    <button onclick="autoFetch()">自動取得</button>
    <button onclick="save()">保存</button>

    <h2 style="margin-top:20px">政治・言語フラグ（手動）</h2>
    <div class="flags">
      <label><input type="checkbox" id="f_rate"> 利上げ容認言語あり</label>
      <label><input type="checkbox" id="f_pressure"> 日銀への直接圧力あり</label>
      <label><input type="checkbox" id="f_giveaway"> 一律給付・恒久補助の兆候あり</label>
      <label><input type="checkbox" id="f_high"> 「金利は高すぎる」言語増加</label>
    </div>
  </div>

  <!-- 右：判定 -->
  <div class="card">
    <h2>観測結果（ルール適用）</h2>

    <div id="state" class="status">—</div>
    <div id="reason" style="margin-top:6px;font-size:12px;color:#9fb2c8">—</div>

    <h2 style="margin-top:20px">判定メモ</h2>
    <pre id="memo">—</pre>
  </div>

</div>

</main>

<script>
/* ========= 自動取得 ========= */

// 為替
async function fetchFX(){
  const r = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=JPY");
  const j = await r.json();
  return j.rates.JPY;
}

// 米10年
async function fetchUS10Y(){
  const r = await fetch("https://fred.stlouisfed.org/graph/fredgraph.csv?id=DGS10");
  const t = await r.text();
  const lines = t.trim().split("\n");
  return parseFloat(lines[lines.length-1].split(",")[1]);
}

async function autoFetch(){
  const fx = await fetchFX();
  const us = await fetchUS10Y();
  document.getElementById("fx").value = fx.toFixed(2);
  document.getElementById("us").value = us.toFixed(2);
  alert("USD/JPY と US10Y を取得しました。\nJGB10Y は確認して入力してください。");
}

/* ========= 判定ロジック ========= */

function evaluate(){
  const fx = parseFloat(fxEl.value);
  const jgb = parseFloat(jgbEl.value);

  const flags = [
    f_pressure.checked,
    f_giveaway.checked,
    f_high.checked
  ];

  let state = "NO ACTION";
  let cls = "ok";
  let reason = "レンジ内・政治フラグ安定";
  let memo =
`・FXはレンジ内かだけを見る
・JGB10Y 2.5%超 → 観測
・3.0%超 or 政治圧力 → 前提変更`;

  if(jgb >= 3.0 || flags.some(v=>v)){
    state = "ASSUMPTION CHANGE";
    cls = "alert";
    reason = "金利3%超 または 政治圧力フラグ";
  }else if(jgb >= 2.5){
    state = "OBSERVE";
    cls = "warn";
    reason = "JGB10Y 監視域";
  }

  stateEl.textContent = state;
  stateEl.className = "status "+cls;
  reasonEl.textContent = reason;
  memoEl.textContent = memo;
}

/* ========= 保存 ========= */

function save(){
  const data = {
    fx: fxEl.value,
    jgb: jgbEl.value,
    us: usEl.value,
    flags:{
      rate:f_rate.checked,
      pressure:f_pressure.checked,
      giveaway:f_giveaway.checked,
      high:f_high.checked
    }
  };
  localStorage.setItem("portfolioOS", JSON.stringify(data));
  evaluate();
}

/* ========= 初期化 ========= */

const fxEl = document.getElementById("fx");
const jgbEl = document.getElementById("jgb");
const usEl = document.getElementById("us");

const f_rate = document.getElementById("f_rate");
const f_pressure = document.getElementById("f_pressure");
const f_giveaway = document.getElementById("f_giveaway");
const f_high = document.getElementById("f_high");

const stateEl = document.getElementById("state");
const reasonEl = document.getElementById("reason");
const memoEl = document.getElementById("memo");

const saved = JSON.parse(localStorage.getItem("portfolioOS")||"null");
if(saved){
  fxEl.value = saved.fx;
  jgbEl.value = saved.jgb;
  usEl.value = saved.us;
  f_rate.checked = saved.flags.rate;
  f_pressure.checked = saved.flags.pressure;
  f_giveaway.checked = saved.flags.giveaway;
  f_high.checked = saved.flags.high;
  evaluate();
}
</script>

</body>
</html>
